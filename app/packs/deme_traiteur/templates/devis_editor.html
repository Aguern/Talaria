<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de Devis - DéMé Traiteur</title>
    <link rel="stylesheet" href="/static/devis_editor.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Éditeur de Devis</h1>
            <p class="subtitle">DéMé Traiteur</p>
        </header>

        <!-- Sélecteur de prestation -->
        <div class="prestation-selector">
            <!-- Mode de sélection -->
            <div class="mode-selector">
                <button onclick="switchMode('dropdown')" class="mode-btn active" data-mode="dropdown">
                    Prestations actives
                </button>
                <button onclick="switchMode('manual')" class="mode-btn" data-mode="manual">
                    Saisie manuelle
                </button>
            </div>

            <!-- Liste déroulante (par défaut) -->
            <div id="dropdown-mode" class="input-group">
                <label for="prestation-select">Prestation</label>
                <select
                    id="prestation-select"
                    aria-label="Sélectionner une prestation"
                    onchange="loadPrestationFromDropdown()"
                >
                    <option value="">Chargement...</option>
                </select>
                <button onclick="loadPrestationFromDropdown()" class="btn-load">Charger</button>
            </div>

            <!-- Saisie manuelle (cachée par défaut) -->
            <div id="manual-mode" class="input-group hidden">
                <label for="prestation-id">ID Prestation</label>
                <input
                    type="text"
                    id="prestation-id"
                    placeholder="ID de la prestation (ex: 12ee0019-fd5c-48c6-b18c-e28be4151cf1)"
                    aria-label="ID de la prestation"
                >
                <button onclick="loadPrestation()" class="btn-load">Charger</button>
            </div>

            <p class="help-text" id="help-dropdown">
                Affichage des prestations "A confirmer" et "Confirmée" avec date >= aujourd'hui
            </p>
            <p class="help-text hidden" id="help-manual">
                L'ID se trouve dans l'URL de la page Notion de la prestation
            </p>
        </div>

        <!-- Zone de statut -->
        <div id="status" class="status hidden" role="status" aria-live="polite"></div>

        <!-- Liste des produits catalogue -->
        <div id="catalogue-section" class="catalogue-section hidden">
            <h2>Catalogue</h2>
            <p class="section-description">
                Sélectionnez les produits et ajustez les quantités. Les modifications seront synchronisées avec Notion.
            </p>

            <!-- Filtres par type -->
            <div class="filters">
                <button onclick="filterByType('all')" class="filter-btn active" data-type="all">
                    Tous les items
                </button>
                <button onclick="filterByType('Produit catalogue')" class="filter-btn" data-type="Produit catalogue">
                    Produits Catalogue
                </button>
                <button onclick="filterByType('RH')" class="filter-btn" data-type="RH">
                    Ressources Humaines
                </button>
            </div>

            <!-- Liste des produits -->
            <div id="catalogue-list" class="catalogue-list">
                <!-- Généré dynamiquement par JavaScript -->
            </div>

            <!-- Bouton validation -->
            <div class="validation-section">
                <button class="btn-validate" onclick="openConfirmationModal()">
                    Valider et synchroniser
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closeConfirmationModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirmer la synchronisation</h2>
                <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-intro">Vous êtes sur le point de synchroniser les modifications suivantes avec Notion :</p>
                <div id="modal-summary" class="modal-summary">
                    <!-- Généré dynamiquement par JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeConfirmationModal()">Annuler</button>
                <button class="btn-confirm" onclick="confirmSave()">Confirmer la synchronisation</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let catalogue = [];
        let lignesExistantes = [];
        let prestationId = null;
        let currentFilter = 'all';
        let prestationsActives = [];
        let currentMode = 'dropdown'; // 'dropdown' ou 'manual'

        // ============================================
        // GESTION DES MODES DE SÉLECTION
        // ============================================

        function switchMode(mode) {
            currentMode = mode;

            // Mettre à jour les boutons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Afficher/masquer les sections
            if (mode === 'dropdown') {
                document.getElementById('dropdown-mode').classList.remove('hidden');
                document.getElementById('manual-mode').classList.add('hidden');
                document.getElementById('help-dropdown').classList.remove('hidden');
                document.getElementById('help-manual').classList.add('hidden');
            } else {
                document.getElementById('dropdown-mode').classList.add('hidden');
                document.getElementById('manual-mode').classList.remove('hidden');
                document.getElementById('help-dropdown').classList.add('hidden');
                document.getElementById('help-manual').classList.remove('hidden');
            }
        }

        // ============================================
        // CHARGEMENT DES PRESTATIONS ACTIVES
        // ============================================

        async function loadActivePrestations() {
            try {
                const res = await fetch('/api/packs/deme-traiteur/prestations/actives');

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                prestationsActives = await res.json();
                console.log(`Prestations actives chargées: ${prestationsActives.length}`);

                // Remplir la liste déroulante
                const select = document.getElementById('prestation-select');
                select.innerHTML = '<option value="">-- Sélectionnez une prestation --</option>';

                prestationsActives.forEach(prestation => {
                    const option = document.createElement('option');
                    option.value = prestation.id;
                    option.textContent = `${prestation.date} - ${prestation.client_name} (${prestation.pax} PAX) - ${prestation.statut}`;
                    select.appendChild(option);
                });

                if (prestationsActives.length === 0) {
                    select.innerHTML = '<option value="">-- Aucune prestation active --</option>';
                }

            } catch (error) {
                console.error('Erreur lors du chargement des prestations actives:', error);
                const select = document.getElementById('prestation-select');
                select.innerHTML = '<option value="">-- Erreur de chargement --</option>';
            }
        }

        // ============================================
        // CHARGEMENT DEPUIS LA LISTE DÉROULANTE
        // ============================================

        async function loadPrestationFromDropdown() {
            const select = document.getElementById('prestation-select');
            prestationId = select.value;

            if (!prestationId) {
                showStatus('Veuillez sélectionner une prestation', 'warning');
                return;
            }

            // Appeler la fonction de chargement commune
            await loadPrestationData();
        }

        // ============================================
        // CHARGEMENT INITIAL DU CATALOGUE
        // ============================================

        async function loadCatalogue() {
            try {
                showStatus('Chargement du catalogue...', 'info');
                const res = await fetch('/api/packs/deme-traiteur/catalogue');

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                catalogue = await res.json();
                console.log(`Catalogue chargé: ${catalogue.length} items`);

                // Masquer le statut une fois chargé
                hideStatus();

            } catch (error) {
                console.error('Erreur lors du chargement du catalogue:', error);
                showStatus(`Erreur : ${error.message}`, 'error');
            }
        }

        // ============================================
        // CHARGEMENT D'UNE PRESTATION (MODE MANUEL)
        // ============================================

        async function loadPrestation() {
            prestationId = document.getElementById('prestation-id').value.trim();

            if (!prestationId) {
                showStatus('Veuillez saisir un ID de prestation', 'warning');
                return;
            }

            await loadPrestationData();
        }

        // ============================================
        // CHARGEMENT DES DONNÉES DE PRESTATION (COMMUN)
        // ============================================

        async function loadPrestationData() {
            try {
                showStatus('Chargement des lignes de devis...', 'info');

                const res = await fetch(`/api/packs/deme-traiteur/lignes/${prestationId}`);

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                lignesExistantes = await res.json();
                console.log(`Lignes chargées: ${lignesExistantes.length}`);

                // Afficher la section catalogue
                document.getElementById('catalogue-section').classList.remove('hidden');

                // Rendre le catalogue avec les données
                renderCatalogue();

                // Mettre à jour les quantités depuis les lignes existantes
                updateQuantities();

                showStatus(`Prestation chargée : ${lignesExistantes.length} ligne(s) de devis`, 'success');

            } catch (error) {
                console.error('Erreur lors du chargement de la prestation:', error);
                showStatus(`Erreur : ${error.message}`, 'error');
            }
        }

        // ============================================
        // RENDU DU CATALOGUE
        // ============================================

        function renderCatalogue() {
            const container = document.getElementById('catalogue-list');
            container.innerHTML = '';

            // Filtrer selon le type sélectionné
            const filteredCatalogue = currentFilter === 'all'
                ? catalogue
                : catalogue.filter(item => item.type === currentFilter);

            if (filteredCatalogue.length === 0) {
                container.innerHTML = '<p class="empty-message">Aucun item trouvé</p>';
                return;
            }

            // Grouper par type
            const groupedByType = {};
            filteredCatalogue.forEach(item => {
                if (!groupedByType[item.type]) {
                    groupedByType[item.type] = [];
                }
                groupedByType[item.type].push(item);
            });

            // Rendre chaque groupe
            Object.keys(groupedByType).sort().forEach(type => {
                // Header du groupe
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `<h3>${type}</h3>`;
                container.appendChild(groupHeader);

                // Items du groupe
                groupedByType[type].forEach(item => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-item';
                    productDiv.dataset.itemId = item.id;
                    productDiv.dataset.type = item.type;

                    productDiv.innerHTML = `
                        <input
                            type="checkbox"
                            data-item-id="${item.id}"
                            aria-label="Sélectionner ${item.nom}"
                            onchange="toggleProduct('${item.id}')"
                        >
                        <span class="product-name">${item.nom}</span>
                        <span class="product-price">${item.prix.toFixed(2)}€</span>
                        <input
                            type="number"
                            class="quantity"
                            min="0"
                            value="0"
                            data-item-id="${item.id}"
                            aria-label="Quantité pour ${item.nom}"
                            onchange="updateCheckbox('${item.id}')"
                        >
                    `;

                    container.appendChild(productDiv);
                });
            });
        }

        // ============================================
        // GESTION DES FILTRES
        // ============================================

        function filterByType(type) {
            currentFilter = type;

            // Sauvegarder l'état actuel avant de re-rendre
            const currentState = saveCurrentState();

            // Mettre à jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // Re-rendre le catalogue
            renderCatalogue();

            // Restaurer l'état sauvegardé
            restoreState(currentState);
        }

        // ============================================
        // SAUVEGARDE ET RESTAURATION DE L'ÉTAT
        // ============================================

        function saveCurrentState() {
            const state = {};
            document.querySelectorAll('.product-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const quantityInput = item.querySelector('input[type="number"]');
                if (checkbox && quantityInput) {
                    const itemId = checkbox.dataset.itemId;
                    state[itemId] = {
                        checked: checkbox.checked,
                        quantity: parseInt(quantityInput.value)
                    };
                }
            });
            return state;
        }

        function restoreState(state) {
            document.querySelectorAll('.product-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const quantityInput = item.querySelector('input[type="number"]');
                if (checkbox && quantityInput) {
                    const itemId = checkbox.dataset.itemId;
                    if (state[itemId]) {
                        checkbox.checked = state[itemId].checked;
                        quantityInput.value = state[itemId].quantity;
                    }
                }
            });
        }

        // ============================================
        // SYNCHRONISATION CHECKBOX <-> QUANTITÉ
        // ============================================

        function toggleProduct(itemId) {
            const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${itemId}"]`);
            const quantityInput = document.querySelector(`input[type="number"][data-item-id="${itemId}"]`);

            if (checkbox.checked && parseInt(quantityInput.value) === 0) {
                quantityInput.value = 1;
            } else if (!checkbox.checked) {
                quantityInput.value = 0;
            }
        }

        function updateCheckbox(itemId) {
            const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${itemId}"]`);
            const quantityInput = document.querySelector(`input[type="number"][data-item-id="${itemId}"]`);

            checkbox.checked = parseInt(quantityInput.value) > 0;
        }

        // ============================================
        // MISE À JOUR DES QUANTITÉS DEPUIS LIGNES EXISTANTES
        // ============================================

        function updateQuantities() {
            lignesExistantes.forEach(ligne => {
                if (!ligne.item_id) return;

                const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${ligne.item_id}"]`);
                const quantityInput = document.querySelector(`input[type="number"][data-item-id="${ligne.item_id}"]`);

                if (checkbox && quantityInput) {
                    checkbox.checked = true;
                    quantityInput.value = ligne.quantite;
                }
            });
        }

        // ============================================
        // MODAL DE CONFIRMATION
        // ============================================

        function openConfirmationModal() {
            if (!prestationId) {
                showStatus('Aucune prestation chargée', 'warning');
                return;
            }

            // Collecter toutes les lignes cochées avec quantité > 0
            const lignes = [];
            const lignesGroupedByType = {};

            document.querySelectorAll('.product-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const quantityInput = item.querySelector('input[type="number"]');

                if (checkbox.checked && parseInt(quantityInput.value) > 0) {
                    const itemId = checkbox.dataset.itemId;
                    const catalogueItem = catalogue.find(c => c.id === itemId);

                    if (catalogueItem) {
                        const ligne = {
                            item_id: itemId,
                            quantite: parseInt(quantityInput.value),
                            nom: catalogueItem.nom,
                            prix: catalogueItem.prix,
                            type: catalogueItem.type
                        };

                        lignes.push(ligne);

                        // Grouper par type
                        if (!lignesGroupedByType[catalogueItem.type]) {
                            lignesGroupedByType[catalogueItem.type] = [];
                        }
                        lignesGroupedByType[catalogueItem.type].push(ligne);
                    }
                }
            });

            if (lignes.length === 0) {
                showStatus('Aucune ligne à sauvegarder (sélectionnez au moins un produit)', 'warning');
                return;
            }

            // Générer le contenu de la modal
            const modalSummary = document.getElementById('modal-summary');
            modalSummary.innerHTML = '';

            // Afficher le total général
            const totalItems = lignes.length;
            const totalQuantity = lignes.reduce((sum, ligne) => sum + ligne.quantite, 0);
            const totalPrice = lignes.reduce((sum, ligne) => sum + (ligne.quantite * ligne.prix), 0);

            const summaryHeader = document.createElement('div');
            summaryHeader.className = 'summary-header';
            summaryHeader.innerHTML = `
                <div class="summary-stat">
                    <span class="stat-label">Articles différents :</span>
                    <span class="stat-value">${totalItems}</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-label">Quantité totale :</span>
                    <span class="stat-value">${totalQuantity}</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-label">Montant total :</span>
                    <span class="stat-value">${totalPrice.toFixed(2)}€</span>
                </div>
            `;
            modalSummary.appendChild(summaryHeader);

            // Afficher par type
            Object.keys(lignesGroupedByType).sort().forEach(type => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'summary-group';

                const groupHeader = document.createElement('h3');
                groupHeader.className = 'summary-group-title';
                groupHeader.textContent = type;
                groupDiv.appendChild(groupHeader);

                const itemsList = document.createElement('div');
                itemsList.className = 'summary-items';

                lignesGroupedByType[type].forEach(ligne => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'summary-item';
                    itemDiv.innerHTML = `
                        <span class="summary-item-name">${ligne.nom}</span>
                        <span class="summary-item-qty">Qté: ${ligne.quantite}</span>
                        <span class="summary-item-price">${(ligne.quantite * ligne.prix).toFixed(2)}€</span>
                    `;
                    itemsList.appendChild(itemDiv);
                });

                groupDiv.appendChild(itemsList);
                modalSummary.appendChild(groupDiv);
            });

            // Ouvrir la modal
            document.getElementById('confirmation-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ============================================
        // SAUVEGARDE DES MODIFICATIONS
        // ============================================

        async function confirmSave() {
            if (!prestationId) {
                showStatus('Aucune prestation chargée', 'warning');
                return;
            }

            // Fermer la modal
            closeConfirmationModal();

            const saveBtn = document.querySelector('.btn-validate');

            try {
                // Collecter toutes les lignes cochées avec quantité > 0
                const lignes = [];
                document.querySelectorAll('.product-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const quantityInput = item.querySelector('input[type="number"]');

                    if (checkbox.checked && parseInt(quantityInput.value) > 0) {
                        lignes.push({
                            item_id: checkbox.dataset.itemId,
                            quantite: parseInt(quantityInput.value)
                        });
                    }
                });

                if (lignes.length === 0) {
                    showStatus('Aucune ligne à sauvegarder (sélectionnez au moins un produit)', 'warning');
                    return;
                }

                // Désactiver le bouton pendant la sauvegarde
                saveBtn.disabled = true;
                saveBtn.textContent = 'Synchronisation en cours...';
                showStatus('Synchronisation avec Notion en cours...', 'info');

                const res = await fetch(`/api/packs/deme-traiteur/lignes/${prestationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lignes })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || `Erreur ${res.status}`);
                }

                const result = await res.json();

                // Afficher un message de succès détaillé
                const details = [];
                if (result.created > 0) details.push(`${result.created} ligne(s) créée(s)`);
                if (result.updated > 0) details.push(`${result.updated} ligne(s) modifiée(s)`);
                if (result.deleted > 0) details.push(`${result.deleted} ligne(s) supprimée(s)`);

                const detailMessage = details.length > 0 ? details.join(', ') : 'Aucune modification';

                showStatus(
                    `✓ Modifications enregistrées dans Notion avec succès\n${detailMessage}`,
                    'success'
                );

                // Réactiver le bouton
                saveBtn.disabled = false;
                saveBtn.textContent = 'Valider et synchroniser';

                // Recharger les lignes pour synchroniser l'affichage
                setTimeout(() => {
                    loadPrestationData();
                }, 2000);

            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showStatus(`✗ Erreur lors de la synchronisation avec Notion\n${error.message}`, 'error');

                // Réactiver le bouton en cas d'erreur
                saveBtn.disabled = false;
                saveBtn.textContent = 'Valider et synchroniser';
            }
        }

        // ============================================
        // GESTION DES MESSAGES DE STATUT
        // ============================================

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.classList.add('hidden');
        }

        // ============================================
        // INITIALISATION AU CHARGEMENT
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Éditeur de devis DéMé Traiteur initialisé');
            loadCatalogue();
            loadActivePrestations();
        });
    </script>
</body>
</html>
