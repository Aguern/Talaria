<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur de Devis - D√©M√© Traiteur</title>
    <link rel="stylesheet" href="/static/devis_editor.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üçï √âditeur de Devis - D√©M√© Traiteur</h1>
            <p class="subtitle">Affinez facilement les lignes de devis d'une prestation</p>
        </header>

        <!-- S√©lecteur de prestation -->
        <div class="prestation-selector">
            <!-- Mode de s√©lection -->
            <div class="mode-selector">
                <button onclick="switchMode('dropdown')" class="mode-btn active" data-mode="dropdown">
                    üìã Prestations actives
                </button>
                <button onclick="switchMode('manual')" class="mode-btn" data-mode="manual">
                    ‚úèÔ∏è Saisie manuelle ID
                </button>
            </div>

            <!-- Liste d√©roulante (par d√©faut) -->
            <div id="dropdown-mode" class="input-group">
                <label for="prestation-select">S√©lectionnez une prestation :</label>
                <select
                    id="prestation-select"
                    aria-label="S√©lectionner une prestation"
                    onchange="loadPrestationFromDropdown()"
                >
                    <option value="">-- Chargement... --</option>
                </select>
                <button onclick="loadPrestationFromDropdown()" class="btn-load">üì• Charger</button>
            </div>

            <!-- Saisie manuelle (cach√©e par d√©faut) -->
            <div id="manual-mode" class="input-group hidden">
                <label for="prestation-id">ID de la Prestation :</label>
                <input
                    type="text"
                    id="prestation-id"
                    placeholder="Collez l'ID de la prestation Notion ici (ex: 12ee0019-fd5c-48c6-b18c-e28be4151cf1)"
                    aria-label="ID de la prestation"
                >
                <button onclick="loadPrestation()" class="btn-load">üì• Charger</button>
            </div>

            <p class="help-text" id="help-dropdown">
                üí° Prestations "A confirmer" ou "Confirm√©e" avec date >= aujourd'hui
            </p>
            <p class="help-text hidden" id="help-manual">
                üí° Copiez l'ID depuis l'URL de la page Notion de la prestation
            </p>
        </div>

        <!-- Zone de statut -->
        <div id="status" class="status hidden" role="status" aria-live="polite"></div>

        <!-- Liste des produits catalogue -->
        <div id="catalogue-section" class="catalogue-section hidden">
            <h2>üìã Catalogue Complet</h2>
            <p class="section-description">
                Cochez les produits souhait√©s et ajustez les quantit√©s.
                Les modifications seront synchronis√©es avec Notion en cliquant sur "Valider".
            </p>

            <!-- Filtres par type -->
            <div class="filters">
                <button onclick="filterByType('all')" class="filter-btn active" data-type="all">
                    Tous les items
                </button>
                <button onclick="filterByType('Produit catalogue')" class="filter-btn" data-type="Produit catalogue">
                    Produits Catalogue
                </button>
                <button onclick="filterByType('RH')" class="filter-btn" data-type="RH">
                    Ressources Humaines
                </button>
            </div>

            <!-- Liste des produits -->
            <div id="catalogue-list" class="catalogue-list">
                <!-- G√©n√©r√© dynamiquement par JavaScript -->
            </div>

            <!-- Bouton validation -->
            <div class="validation-section">
                <button class="btn-validate" onclick="saveDevis()">
                    ‚úÖ Valider et synchroniser avec Notion
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let catalogue = [];
        let lignesExistantes = [];
        let prestationId = null;
        let currentFilter = 'all';
        let prestationsActives = [];
        let currentMode = 'dropdown'; // 'dropdown' ou 'manual'

        // ============================================
        // GESTION DES MODES DE S√âLECTION
        // ============================================

        function switchMode(mode) {
            currentMode = mode;

            // Mettre √† jour les boutons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Afficher/masquer les sections
            if (mode === 'dropdown') {
                document.getElementById('dropdown-mode').classList.remove('hidden');
                document.getElementById('manual-mode').classList.add('hidden');
                document.getElementById('help-dropdown').classList.remove('hidden');
                document.getElementById('help-manual').classList.add('hidden');
            } else {
                document.getElementById('dropdown-mode').classList.add('hidden');
                document.getElementById('manual-mode').classList.remove('hidden');
                document.getElementById('help-dropdown').classList.add('hidden');
                document.getElementById('help-manual').classList.remove('hidden');
            }
        }

        // ============================================
        // CHARGEMENT DES PRESTATIONS ACTIVES
        // ============================================

        async function loadActivePrestations() {
            try {
                const res = await fetch('/api/packs/deme-traiteur/prestations/actives');

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                prestationsActives = await res.json();
                console.log(`Prestations actives charg√©es: ${prestationsActives.length}`);

                // Remplir la liste d√©roulante
                const select = document.getElementById('prestation-select');
                select.innerHTML = '<option value="">-- S√©lectionnez une prestation --</option>';

                prestationsActives.forEach(prestation => {
                    const option = document.createElement('option');
                    option.value = prestation.id;
                    option.textContent = `${prestation.date} - ${prestation.client_name} (${prestation.pax} PAX) - ${prestation.statut}`;
                    select.appendChild(option);
                });

                if (prestationsActives.length === 0) {
                    select.innerHTML = '<option value="">-- Aucune prestation active --</option>';
                }

            } catch (error) {
                console.error('Erreur lors du chargement des prestations actives:', error);
                const select = document.getElementById('prestation-select');
                select.innerHTML = '<option value="">-- Erreur de chargement --</option>';
            }
        }

        // ============================================
        // CHARGEMENT DEPUIS LA LISTE D√âROULANTE
        // ============================================

        async function loadPrestationFromDropdown() {
            const select = document.getElementById('prestation-select');
            prestationId = select.value;

            if (!prestationId) {
                showStatus('‚ö†Ô∏è Veuillez s√©lectionner une prestation', 'warning');
                return;
            }

            // Appeler la fonction de chargement commune
            await loadPrestationData();
        }

        // ============================================
        // CHARGEMENT INITIAL DU CATALOGUE
        // ============================================

        async function loadCatalogue() {
            try {
                showStatus('Chargement du catalogue...', 'info');
                const res = await fetch('/api/packs/deme-traiteur/catalogue');

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                catalogue = await res.json();
                console.log(`Catalogue charg√©: ${catalogue.length} items`);

                // Masquer le statut une fois charg√©
                hideStatus();

            } catch (error) {
                console.error('Erreur lors du chargement du catalogue:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // ============================================
        // CHARGEMENT D'UNE PRESTATION (MODE MANUEL)
        // ============================================

        async function loadPrestation() {
            prestationId = document.getElementById('prestation-id').value.trim();

            if (!prestationId) {
                showStatus('‚ö†Ô∏è Veuillez saisir un ID de prestation', 'warning');
                return;
            }

            await loadPrestationData();
        }

        // ============================================
        // CHARGEMENT DES DONN√âES DE PRESTATION (COMMUN)
        // ============================================

        async function loadPrestationData() {
            try {
                showStatus('Chargement des lignes de devis...', 'info');

                const res = await fetch(`/api/packs/deme-traiteur/lignes/${prestationId}`);

                if (!res.ok) {
                    throw new Error(`Erreur ${res.status}: ${res.statusText}`);
                }

                lignesExistantes = await res.json();
                console.log(`Lignes charg√©es: ${lignesExistantes.length}`);

                // Afficher la section catalogue
                document.getElementById('catalogue-section').classList.remove('hidden');

                // Rendre le catalogue avec les donn√©es
                renderCatalogue();

                // Mettre √† jour les quantit√©s depuis les lignes existantes
                updateQuantities();

                showStatus(`‚úÖ Prestation charg√©e : ${lignesExistantes.length} ligne(s) de devis trouv√©e(s)`, 'success');

            } catch (error) {
                console.error('Erreur lors du chargement de la prestation:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // ============================================
        // RENDU DU CATALOGUE
        // ============================================

        function renderCatalogue() {
            const container = document.getElementById('catalogue-list');
            container.innerHTML = '';

            // Filtrer selon le type s√©lectionn√©
            const filteredCatalogue = currentFilter === 'all'
                ? catalogue
                : catalogue.filter(item => item.type === currentFilter);

            if (filteredCatalogue.length === 0) {
                container.innerHTML = '<p class="empty-message">Aucun item trouv√©</p>';
                return;
            }

            // Grouper par type
            const groupedByType = {};
            filteredCatalogue.forEach(item => {
                if (!groupedByType[item.type]) {
                    groupedByType[item.type] = [];
                }
                groupedByType[item.type].push(item);
            });

            // Rendre chaque groupe
            Object.keys(groupedByType).sort().forEach(type => {
                // Header du groupe
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `<h3>${type}</h3>`;
                container.appendChild(groupHeader);

                // Items du groupe
                groupedByType[type].forEach(item => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'product-item';
                    productDiv.dataset.itemId = item.id;
                    productDiv.dataset.type = item.type;

                    productDiv.innerHTML = `
                        <input
                            type="checkbox"
                            data-item-id="${item.id}"
                            aria-label="S√©lectionner ${item.nom}"
                            onchange="toggleProduct('${item.id}')"
                        >
                        <span class="product-name">${item.nom}</span>
                        <span class="product-price">${item.prix.toFixed(2)}‚Ç¨</span>
                        <input
                            type="number"
                            class="quantity"
                            min="0"
                            value="0"
                            data-item-id="${item.id}"
                            aria-label="Quantit√© pour ${item.nom}"
                            onchange="updateCheckbox('${item.id}')"
                        >
                    `;

                    container.appendChild(productDiv);
                });
            });
        }

        // ============================================
        // GESTION DES FILTRES
        // ============================================

        function filterByType(type) {
            currentFilter = type;

            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // Re-rendre le catalogue
            renderCatalogue();

            // Re-appliquer les quantit√©s
            updateQuantities();
        }

        // ============================================
        // SYNCHRONISATION CHECKBOX <-> QUANTIT√â
        // ============================================

        function toggleProduct(itemId) {
            const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${itemId}"]`);
            const quantityInput = document.querySelector(`input[type="number"][data-item-id="${itemId}"]`);

            if (checkbox.checked && parseInt(quantityInput.value) === 0) {
                quantityInput.value = 1;
            } else if (!checkbox.checked) {
                quantityInput.value = 0;
            }
        }

        function updateCheckbox(itemId) {
            const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${itemId}"]`);
            const quantityInput = document.querySelector(`input[type="number"][data-item-id="${itemId}"]`);

            checkbox.checked = parseInt(quantityInput.value) > 0;
        }

        // ============================================
        // MISE √Ä JOUR DES QUANTIT√âS DEPUIS LIGNES EXISTANTES
        // ============================================

        function updateQuantities() {
            lignesExistantes.forEach(ligne => {
                if (!ligne.item_id) return;

                const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${ligne.item_id}"]`);
                const quantityInput = document.querySelector(`input[type="number"][data-item-id="${ligne.item_id}"]`);

                if (checkbox && quantityInput) {
                    checkbox.checked = true;
                    quantityInput.value = ligne.quantite;
                }
            });
        }

        // ============================================
        // SAUVEGARDE DES MODIFICATIONS
        // ============================================

        async function saveDevis() {
            if (!prestationId) {
                showStatus('‚ö†Ô∏è Aucune prestation charg√©e', 'warning');
                return;
            }

            try {
                // Collecter toutes les lignes coch√©es avec quantit√© > 0
                const lignes = [];
                document.querySelectorAll('.product-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const quantityInput = item.querySelector('input[type="number"]');

                    if (checkbox.checked && parseInt(quantityInput.value) > 0) {
                        lignes.push({
                            item_id: checkbox.dataset.itemId,
                            quantite: parseInt(quantityInput.value)
                        });
                    }
                });

                if (lignes.length === 0) {
                    showStatus('‚ö†Ô∏è Aucune ligne √† sauvegarder (s√©lectionnez au moins un produit)', 'warning');
                    return;
                }

                showStatus('üíæ Sauvegarde en cours...', 'info');

                const res = await fetch(`/api/packs/deme-traiteur/lignes/${prestationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lignes })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || `Erreur ${res.status}`);
                }

                const result = await res.json();

                showStatus(
                    `‚úÖ Synchronisation r√©ussie ! ${result.message}`,
                    'success'
                );

                // Recharger les lignes pour synchroniser l'affichage
                setTimeout(() => {
                    loadPrestationData();
                }, 1500);

            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showStatus(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // ============================================
        // GESTION DES MESSAGES DE STATUT
        // ============================================

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.classList.add('hidden');
        }

        // ============================================
        // INITIALISATION AU CHARGEMENT
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('√âditeur de devis D√©M√© Traiteur initialis√©');
            loadCatalogue();
            loadActivePrestations();
        });
    </script>
</body>
</html>
